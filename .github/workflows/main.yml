name: DevSecOps AWS Pipeline

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

env:
  TF_WORKING_DIR: src
  TERRAFORM_VERSION: 1.5.6
  AWS_REGION: us-east-1

permissions:
  id-token: write
  contents: read

jobs:

  # -------------------------------
  # 1. Build & Unit Tests
  # -------------------------------
  build:
    name: Build & Unit Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache Node Modules
        id: cache-node
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Install Dependencies
        if: hashFiles('**/package.json') != ''
        run: npm ci

      - name: Run Unit Tests
        if: hashFiles('**/package.json') != ''
        run: npm test


  # -------------------------------
  # 2. SAST + SCA (SonarCloud + Snyk)
  # -------------------------------
  sast_sca:
    name: SAST & SCA Scans
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.sources=.

      - name: Snyk SCA Scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

      - name: Snyk Monitor
        if: success()
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor


  # -------------------------------
  # 3. Terraform Plan
  # -------------------------------
  terraform_plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: sast_sca
    outputs:
      plan-path: ${{ steps.upload-plan.outputs.artifact-path || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false -no-color

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate -no-color

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -out=tfplan -input=false -no-color
          terraform show -json tfplan > tfplan.json

      - name: Upload tfplan Artifact
        id: upload-plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/tfplan.json


  # -------------------------------
  # 4. Manual Approval
  # -------------------------------
  manual_approval:
    name: Manual Approval
    runs-on: ubuntu-latest
    needs: terraform_plan
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Await Approval
        uses: hmarr/auto-approve-action@v2


  # -------------------------------
  # 5. Terraform Apply
  # -------------------------------
  terraform_apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform_plan, manual_approval]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve tfplan


  # -------------------------------
  # 6. DAST â€” ZAP
  # -------------------------------
  dast_zap:
    name: DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: terraform_apply

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.APP_URL || secrets.APP_URL }}
          cmd_options: "-r zap_report.html"
        continue-on-error: true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-${{ github.run_id }}
          path: zap_report.html

