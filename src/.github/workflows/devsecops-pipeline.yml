name: DevSecOps AWS Pipeline

on:
  push:
    branches:
      - "**"     # Run on ALL branches in your fork
  pull_request:
    branches:
      - main     # PRs to main also run

env:
  TF_WORKING_DIR: src/terraform
  TERRAFORM_VERSION: 1.5.6
  AWS_REGION: us-east-1

permissions:
  id-token: write
  contents: read

jobs:
  build:
    name: Build & Unit Test (Node)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install Dependencies
        if: hashFiles('**/package.json') != ''
        run: npm ci

      - name: Run Unit Tests
        if: hashFiles('**/package.json') != ''
        run: npm test


  # -----------------------------------------------------------
  # 2. SAST + SCA
  # -----------------------------------------------------------
  sast_sca:
    name: SAST & SCA Scans
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Maven Project
        run: mvn -B -DskipTests clean package

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@v5.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=embihbiggs
            -Dsonar.projectKey=embihbiggs_devsecops-jenkins-k8s-tf-sast-sca-dast-sonarcloud-snyk-zap-e2e-repo
            -Dsonar.host.url=https://sonarcloud.io
            -Dsonar.sources=src/main/java
            -Dsonar.java.binaries=target/classes

      - name: Snyk SCA Scan
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=low
        continue-on-error: true

      - name: Snyk Monitor
        uses: snyk/actions/maven@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor


  # -----------------------------------------------------------
  # 3. Terraform Plan
  # -----------------------------------------------------------
  terraform_plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: sast_sca

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false

      - name: Terraform Validate
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform validate

      - name: Select Workspace Based on Branch
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          workspace=$(echo "${GITHUB_REF##*/}" | tr '/' '-')
          terraform workspace select "$workspace" || terraform workspace new "$workspace"

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -out=tfplan
          terraform show -json tfplan > tfplan.json

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/tfplan.json


  # -----------------------------------------------------------
  # 4. Manual Approval (only for main)
  # -----------------------------------------------------------
  manual_approval:
    name: Manual Approval Before Apply
    runs-on: ubuntu-latest
    needs: terraform_plan
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Wait For Approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ secrets.APPROVAL_SECRET }}
          approvers: "Biggs,YourTeam"

  # -----------------------------------------------------------
  # 5. Terraform Apply (main only)
  # -----------------------------------------------------------
  terraform_apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform_plan, manual_approval]
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply -auto-approve tfplan

  # -----------------------------------------------------------
  # 6. DAST (ZAP)
  # -----------------------------------------------------------
  dast_zap:
    name: DAST Scan (OWASP ZAP)
    runs-on: ubuntu-latest
    needs: terraform_apply
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ secrets.APP_URL }}
          cmd_options: "-r zap_report.html"
        continue-on-error: true

      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-${{ github.run_id }}
          path: zap_report.html

  # -----------------------------------------------------------
  # 7. AWS Security Services
  # -----------------------------------------------------------
  aws_security_services:
    name: AWS Security Services
    runs-on: ubuntu-latest
    needs: terraform_apply
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Enable AWS Security Services
        run: |
          aws guardduty create-detector --enable || true
          aws inspector2 enable --resource-types EC2 ECR LAMBDA || true
          aws securityhub enable-security-hub || true


  # -----------------------------------------------------------
  # 8. Compliance Report
  # -----------------------------------------------------------
  compliance_report:
    name: Compliance & Findings
    runs-on: ubuntu-latest
    needs: [aws_security_services, dast_zap]
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download AWS Findings
        run: |
          aws securityhub get-findings --max-results 50 > security_findings.json || echo '{}' > security_findings.json

      - name: Upload Findings
        uses: actions/upload-artifact@v4
        with:
          name: aws-security-findings-${{ github.run_id }}
          path: security_findings.json

  # -----------------------------------------------------------
  # 9. Notifications
  # -----------------------------------------------------------
  notify:
    name: Notify Team
    runs-on: ubuntu-latest
    needs: [terraform_apply, dast_zap, compliance_report]
    if: always()

    steps:
      - name: Slack Notification
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "*DevSecOps Pipeline Completed* on `${{ github.ref }}`",
              "attachments": [
                { "text": "SAST, SCA, Terraform, DAST & AWS Security checks completed." }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
