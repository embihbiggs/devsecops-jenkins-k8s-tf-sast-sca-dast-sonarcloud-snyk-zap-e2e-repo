name: DevSecOps AWS Pipeline

# Triggers
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: read
  id-token: write   # required for OIDC
  packages: read

env:
  TF_WORKING_DIR: infra
  TERRAFORM_VERSION: 1.5.6    
  AWS_REGION: us-east-1       # default region

concurrency:
  group: devsecops-${{ github.ref }}
  cancel-in-progress: true

jobs:

  # Build & unit tests
  build:
    runs-on: ubuntu-latest
    outputs:
      node-cache-hit: ${{ steps.cache-node.outputs.cache-hit || '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node (if applicable)
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Cache node modules
        id: cache-node
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        if: exists('package.json')
        run: npm ci

      - name: Run unit tests
        if: exists('package.json')
        run: npm test

  # SAST (SonarCloud) + SCA (Snyk)
  sast_sca:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # SonarCloud scan (adjust to SonarQube if self-hosted)
      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@master
        with:
          args: >
            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Snyk SCA
      - name: Snyk Test
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test

      - name: Snyk Monitor (store snapshot)
        if: success()
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor

  #Terraform plan (in PRs and on develop)
  terraform_plan:
    runs-on: ubuntu-latest
    needs: sast_sca
    outputs:
      plan-path: ${{ steps.upload-plan.outputs.artifact-path || '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials via OIDC (short-lived)
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Init Terraform
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init -input=false -no-color

      - name: Select or create workspace
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          workspace=${GITHUB_REF##*/}
          terraform workspace select "$workspace" || terraform workspace new "$workspace"

      - name: Terraform plan
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform plan -out=tfplan -input=false -no-color
          terraform show -json tfplan > tfplan.json
        env:
          TF_VAR_git_branch: ${{ github.ref }}

      - name: Upload tfplan artifact
        id: upload-plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/tfplan.json

  #Manual approval before apply to protected branches/environments
  manual_approval:
    runs-on: ubuntu-latest
    needs: terraform_plan
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Await manual approval (environment protection recommended)
        uses: hmarr/auto-approve-action@v2
        # NOTE: replace above with your preferred approval workflow or rely on GitHub Environments.
        # Many orgs use "environments" with required reviewers instead of in-workflow approvals.

  #Terraform apply (only after approval and for non-PRs)
  terraform_apply:
    runs-on: ubuntu-latest
    needs: [terraform_plan, manual_approval]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.GITHUB_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.run_id }}

      - name: Terraform apply
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          # apply previously created plan
          terraform apply -input=false -auto-approve tfplan

      - name: Export deployed app URL (example)
        id: export
        run: |
          # replace with real data source, e.g., output from terraform or kubectl ingress
          echo "APP_URL=https://$(terraform output -raw alb_dns_name 2>/dev/null || echo 'example-app.local')" >> $GITHUB_ENV

  # DAST - OWASP ZAP baseline scan against deployed endpoint
  dast_zap:
    runs-on: ubuntu-latest
    needs: terraform_apply
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run OWASP ZAP baseline scan
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: ${{ env.APP_URL || secrets.APP_URL }}
          # optional: provide context file, rules, api-key, and additional args
        continue-on-error: true

      - name: Upload ZAP reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: zap-report-${{ github.run_id }}
          path: zap_report.html

  # Post-processing: send findings to Security Hub / Slack 
  notify:
    runs-on: ubuntu-latest
    needs: [terraform_apply, dast_zap]
    steps:
      - name: Send notification to Slack (example)
        if: always()
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "Pipeline ${{ github.workflow }} #${{ github.run_id }} finished. Branch: ${{ github.ref }}",
              "attachments": [
                {"text": "SAST/SCA checks ran. Check Security Hub / ZAP reports for details."}
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
